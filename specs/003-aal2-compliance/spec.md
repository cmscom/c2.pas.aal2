# Feature Specification: AAL2 Compliance with Passkey Re-authentication

**Feature Branch**: `003-aal2-compliance`
**Created**: 2025-11-06
**Status**: Draft
**Input**: User description: "AAL2に対応するために、新規のパーミッション、新規のロールを作って、パスキーを使って認証を15分以内にしているか、チャレンジで確認を行う。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Elevated Permission Protection (Priority: P1)

管理者が特定のコンテンツやリソースに対して、AAL2レベルの認証を要求する保護を設定できる。ユーザーが保護されたリソースにアクセスする際、最後の認証が15分以上前であれば、パスキーによる再認証を求められる。

**Why this priority**: セキュリティの核心機能であり、AAL2コンプライアンスの実現に必要不可欠。この機能なしでは、AAL2要件を満たすことができない。

**Independent Test**: 管理者がコンテンツに新しいパーミッションを設定し、ユーザーが15分経過後にアクセスを試みてパスキーチャレンジが表示されることで、独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** 管理者がログイン済み、**When** コンテンツに「AAL2保護」パーミッションを設定、**Then** パーミッション設定が保存され、そのコンテンツがAAL2保護対象となる
2. **Given** ユーザーが10分前にパスキーで認証済み、**When** AAL2保護コンテンツにアクセス、**Then** 再認証なしで即座にアクセスが許可される
3. **Given** ユーザーが20分前に認証済み、**When** AAL2保護コンテンツにアクセス、**Then** パスキーによる再認証チャレンジが表示される
4. **Given** ユーザーが再認証チャレンジを受ける、**When** パスキーで正しく認証、**Then** コンテンツへのアクセスが許可され、認証タイムスタンプが更新される
5. **Given** ユーザーが再認証チャレンジを受ける、**When** パスキー認証に失敗またはキャンセル、**Then** アクセスが拒否され、適切なエラーメッセージが表示される

---

### User Story 2 - AAL2 Role Management (Priority: P2)

管理者が「AAL2 Required」などのロールを作成し、そのロールを持つユーザーには常にAAL2レベルの認証を要求できる。これにより、特権ユーザー（経理、人事、システム管理者など）に対して、包括的なセキュリティポリシーを適用できる。

**Why this priority**: ユーザーグループ全体にセキュリティポリシーを適用する効率的な方法を提供。P1の個別コンテンツ保護を補完する機能。

**Independent Test**: 管理者が新しいAAL2ロールを作成し、ユーザーに割り当てて、そのユーザーが任意のリソースにアクセスする際に15分ルールが適用されることで、独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** 管理者がログイン済み、**When** 新しい「AAL2 Required」ロールを作成、**Then** ロールが作成され、AAL2認証要件が関連付けられる
2. **Given** AAL2ロールが存在、**When** 管理者がユーザーにそのロールを割り当て、**Then** ユーザーがAAL2認証ポリシーの対象となる
3. **Given** ユーザーがAAL2ロールを持つ、**When** 最後の認証から15分以上経過後に任意のアクションを実行、**Then** パスキー再認証が要求される
4. **Given** AAL2ロールを持つユーザー、**When** 15分以内にアクションを実行、**Then** 再認証なしでアクションが許可される

---

### User Story 3 - Authentication Session Tracking (Priority: P1)

システムがユーザーの認証タイムスタンプを正確に追跡し、15分の有効期限を管理する。パスキー認証が成功するたびに、タイムスタンプが更新される。

**Why this priority**: P1機能の基盤となる必須機能。正確なタイムスタンプ管理なしでは、15分ルールを実装できない。

**Independent Test**: ユーザーがパスキーで認証し、システムが認証時刻を記録し、15分後に自動的に期限切れとなることで、独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** ユーザーが初回パスキー認証、**When** 認証成功、**Then** システムがAAL2認証タイムスタンプを記録する
2. **Given** ユーザーがAAL2認証済み、**When** 再度パスキー認証を実行、**Then** タイムスタンプが最新の認証時刻に更新される
3. **Given** AAL2認証タイムスタンプが記録済み、**When** 15分が経過、**Then** システムがAAL2認証を期限切れとみなす
4. **Given** 複数のブラウザセッション、**When** 一つのセッションで再認証、**Then** 他のセッションにも認証状態が反映される（同一ユーザー）

---

### User Story 4 - Clear User Feedback (Priority: P3)

ユーザーがAAL2保護リソースにアクセスしようとした際、なぜ再認証が必要なのか、いつ認証が期限切れになるのかを明確に理解できる。

**Why this priority**: ユーザー体験の向上。基本機能は動作するが、より良いUXを提供。

**Independent Test**: ユーザーインターフェースにアクセスして、メッセージの明確さと情報の正確性を確認することで、独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** ユーザーがAAL2チャレンジを受ける、**When** チャレンジ画面を表示、**Then** 「セキュリティ保護されたリソースへのアクセスには追加認証が必要です」という明確なメッセージが表示される
2. **Given** ユーザーがAAL2認証済み、**When** ユーザープロファイルを確認、**Then** 次の再認証が必要となる時刻が表示される
3. **Given** 再認証チャレンジ、**When** ユーザーが認証をキャンセル、**Then** 「アクセスには認証が必要です。後でもう一度お試しください」という適切なメッセージが表示される

---

### Edge Cases

- ユーザーがパスキー認証中にブラウザを閉じた場合、どうなるか？
- ユーザーが14分59秒後にAAL2保護リソースへのアクセスを開始し、チャレンジ画面が表示される前に15分が経過した場合、どうなるか？
- システム時刻が変更された場合（例：サーバーの時刻調整）、認証タイムスタンプはどう扱われるか？
- ユーザーが複数のパスキーを登録している場合、どのパスキーでも再認証可能か？
- AAL2ロールとAAL2パーミッションの両方が適用される場合、どちらが優先されるか（またはどう組み合わされるか）？
- ユーザーがパスキーを持っていない（または失った）場合、AAL2保護リソースにアクセスできないか？代替手段はあるか？
- セッションタイムアウト（例：30分）とAAL2タイムアウト（15分）の関係はどうなるか？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、コンテンツやリソースに適用可能な新しいパーミッション「Require AAL2 Authentication」を提供しなければならない
- **FR-002**: システムは、ユーザーに割り当て可能な新しいロール「AAL2 Required User」を提供しなければならない
- **FR-003**: システムは、ユーザーのパスキー認証タイムスタンプを正確に記録・管理しなければならない
- **FR-004**: システムは、ユーザーがAAL2保護リソースにアクセスしようとした際、最後のパスキー認証から15分以上経過している場合、パスキー再認証チャレンジを表示しなければならない
- **FR-005**: システムは、ユーザーがAAL2ロールを持つ場合、任意のリソースへのアクセス時に15分ルールを適用しなければならない
- **FR-006**: システムは、パスキー再認証が成功した際、AAL2認証タイムスタンプを現在時刻に更新しなければならない
- **FR-007**: システムは、再認証が失敗またはキャンセルされた場合、AAL2保護リソースへのアクセスを拒否しなければならない
- **FR-008**: 管理者は、既存のコンテンツ・リソースに「Require AAL2 Authentication」パーミッションを設定・解除できなければならない
- **FR-009**: 管理者は、ユーザーに「AAL2 Required User」ロールを割り当て・削除できなければならない
- **FR-010**: システムは、AAL2認証タイムスタンプをユーザーセッション全体で一貫して管理しなければならない（複数タブ・ウィンドウ間で共有）
- **FR-011**: システムは、ユーザーが登録している任意のパスキーでAAL2再認証を許可しなければならない
- **FR-012**: システムは、AAL2チャレンジ時に、なぜ再認証が必要なのかをユーザーに明確に伝えなければならない

### Key Entities

- **AAL2 Permission**: AAL2認証を要求する新しいパーミッション。コンテンツ、フォルダ、またはリソースに適用可能。
- **AAL2 Role**: ユーザーに割り当て可能な新しいロール。このロールを持つユーザーは、常にAAL2認証ポリシーの対象となる。
- **AAL2 Authentication Timestamp**: ユーザーが最後にパスキーで認証した時刻を記録するタイムスタンプ。ユーザーオブジェクトまたはセッションに保存される。
- **Passkey Credential**: ユーザーが登録したパスキー（既存の002機能）。AAL2再認証に使用される。
- **Protected Resource**: AAL2パーミッションが設定されたコンテンツやリソース。アクセス時にAAL2チェックが実行される。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 管理者は、5クリック以内でコンテンツにAAL2保護を設定できる
- **SC-002**: ユーザーは、パスキー再認証を10秒以内に完了できる（平均）
- **SC-003**: AAL2保護リソースへのアクセス試行の100%で、15分ルールが正確に適用される（±5秒の誤差）
- **SC-004**: ユーザーの90%以上が、再認証チャレンジの理由を理解できる（ユーザーテストまたはアンケート）
- **SC-005**: システムは、100,000以上の同時ユーザーでAAL2認証タイムスタンプを正確に管理できる
- **SC-006**: AAL2機能の導入により、通常のページロード時間が10%以上増加しない
- **SC-007**: AAL2関連のエラー（タイムスタンプの不整合、認証失敗など）がユーザーセッションの1%未満で発生する

## Assumptions *(if applicable)*

- ユーザーは既にパスキーを登録している（002-passkey-login機能が実装済み）
- Plone.PASの拡張により、カスタムパーミッションとロールの作成が可能
- ZODB（Zope Object Database）にユーザーオブジェクトやセッション情報を保存できる
- サーバー時刻は正確で、NTPなどで同期されている
- 15分のタイムウィンドウは固定値（将来的には設定可能にする可能性があるが、初期実装では固定）
- AAL2再認証は、通常のセッションタイムアウト（例：30分）とは独立して管理される
- パスキーが利用できない環境やブラウザの場合、AAL2保護リソースへのアクセスは不可（フォールバックなし）

## Out of Scope *(if applicable)*

- AAL3レベルの認証（ハードウェアトークンなど）
- 15分以外のカスタマイズ可能なタイムウィンドウ（初期実装では固定）
- パスキー以外の認証方法（SMS、TOTPなど）によるAAL2対応
- AAL2監査ログの詳細レポート機能（基本的なロギングは含むが、詳細レポートは対象外）
- AAL2要件のAPI単位での細かい制御（コンテンツ・リソース単位のみ）
- 管理者による強制的なユーザー再認証トリガー
