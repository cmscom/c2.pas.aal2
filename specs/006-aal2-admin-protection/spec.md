# Feature Specification: AAL2 Protection for Plone Admin Interfaces

**Feature Branch**: `006-aal2-admin-protection`
**Created**: 2025-11-10
**Status**: Draft
**Input**: User description: "ここまでで、パスキーでログインして、認証が継続することができました。次にAAL2で防止するものを定めていきたいです。Ploneの管理画面のいくつかに、15分以内のパスキー認証がされていることを確認する仕組みを導入したいです。まずはここまでの実装状況を踏まえて次の機能の設計に入ってください。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Admin Interface AAL2 Protection (Priority: P1)

管理者が特定の管理画面（コントロールパネル、ユーザー管理、サイト設定など）にアクセスする際、システムが最後のパスキー認証から15分以上経過しているかを確認し、経過している場合はパスキーによる再認証を要求する。これにより、通常のセッション認証とは別に、管理操作に追加のセキュリティレイヤーを提供する。

**Why this priority**: 管理画面へのアクセスは高い権限を必要とする操作であり、セキュリティリスクが最も高い。AAL2保護を最も必要とする領域であり、ユーザー価値が即座に提供される。

**Independent Test**: 管理者権限を持つユーザーが通常ログインし、20分待機後にコントロールパネルにアクセスしようとすると、パスキー再認証チャレンジが表示され、認証後にアクセスが許可されることで、独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** 管理者が10分前にパスキーで認証済み、**When** コントロールパネルにアクセス、**Then** 再認証なしで即座にアクセスが許可される
2. **Given** 管理者が20分前にパスキーで認証済み、**When** ユーザー管理画面にアクセス、**Then** パスキー再認証チャレンジが表示される
3. **Given** 管理者が再認証チャレンジを受ける、**When** パスキーで正しく認証、**Then** 管理画面へのアクセスが許可され、AAL2タイムスタンプが更新される
4. **Given** 管理者が再認証チャレンジを受ける、**When** パスキー認証に失敗またはキャンセル、**Then** 管理画面へのアクセスが拒否され、適切なエラーメッセージが表示される
5. **Given** 管理者が管理画面で作業中、**When** 15分が経過し次のページに移動、**Then** 再度パスキー認証が要求される

---

### User Story 2 - Protected Admin Interface Configuration (Priority: P2)

管理者が、どの管理画面にAAL2保護を適用するかを設定できる。初期設定では、主要な管理画面（コントロールパネル、ユーザー管理、サイト設定、Add-on管理）がデフォルトで保護されるが、管理者は保護対象を追加・削除できる。

**Why this priority**: 異なる組織には異なるセキュリティ要件がある。設定可能性により、組織のセキュリティポリシーに合わせたカスタマイズが可能になる。P1の基本保護機能を補完。

**Independent Test**: サイト管理者がAAL2設定画面にアクセスし、保護対象の管理画面リストを表示・編集し、設定を保存後、実際にその画面にアクセスして保護が適用されることで、独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** サイト管理者がAAL2設定画面にアクセス、**When** 保護対象の管理画面リストを表示、**Then** 現在保護されている管理画面が一覧表示される
2. **Given** AAL2設定画面、**When** 新しい管理画面URLパターンを保護リストに追加、**Then** その画面がAAL2保護の対象となる
3. **Given** AAL2設定画面、**When** 既存の保護対象を削除、**Then** その画面はAAL2保護なしでアクセス可能になる
4. **Given** 初回インストール時、**When** システムが初期化される、**Then** 主要管理画面（コントロールパネル、ユーザー管理など）がデフォルトで保護対象として設定される

---

### User Story 3 - Clear Re-authentication UX (Priority: P2)

管理画面にアクセスしようとした管理者が、AAL2再認証が必要な理由と、どの画面にアクセスしようとしているかを明確に理解できる。再認証後は、元々アクセスしようとしていた画面に自動的にリダイレクトされる。

**Why this priority**: ユーザー体験の向上により、管理者の作業効率が維持される。セキュリティ機能が煩わしさではなく、保護として認識されるために重要。

**Independent Test**: 15分経過後に管理画面にアクセスしようとすると、明確なメッセージを含む再認証画面が表示され、認証後に元のページにリダイレクトされることで、独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** 管理者がAAL2保護された画面にアクセス、**When** 再認証が必要、**Then** 「セキュリティ保護された管理画面へのアクセスには、15分以内のパスキー認証が必要です」という明確なメッセージが表示される
2. **Given** 再認証チャレンジ画面、**When** 画面に表示される情報を確認、**Then** アクセスしようとしている管理画面の名前とURLが表示される
3. **Given** 管理者が再認証を完了、**When** パスキー認証成功、**Then** 元々アクセスしようとしていた管理画面に自動的にリダイレクトされる
4. **Given** 再認証画面、**When** 「キャンセル」を選択、**Then** 安全な場所（ダッシュボードまたはホーム）にリダイレクトされ、適切なメッセージが表示される

---

### User Story 4 - AAL2 Status Visibility (Priority: P3)

管理者が、現在のAAL2認証状態を確認できる。ユーザープロファイルまたは管理画面のヘッダーに、最後のパスキー認証時刻と、次の再認証が必要となるまでの残り時間が表示される。

**Why this priority**: ユーザー体験の向上だが、基本機能なしでもシステムは動作する。管理者が予期しない再認証を避け、重要な操作前に事前に再認証できる。

**Independent Test**: 管理者としてログインし、ヘッダーまたはプロファイルでAAL2ステータス情報を表示し、時間経過とともに残り時間が減少することで、独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** 管理者が5分前にパスキーで認証、**When** 管理画面ヘッダーを確認、**Then** 「AAL2認証有効: あと10分」のような表示が見える
2. **Given** AAL2認証が期限切れ、**When** ヘッダーを確認、**Then** 「AAL2認証が必要です」または類似の警告が表示される
3. **Given** 管理者がAAL2ステータスインジケーターをクリック、**When** 詳細を表示、**Then** 最後の認証時刻、次の期限、保護対象の管理画面リストが表示される
4. **Given** 期限が近づいている（例：残り2分）、**When** ヘッダーを確認、**Then** 視覚的な警告（色の変化など）で通知される

---

### Edge Cases

- 管理者が14分59秒後に管理画面にアクセスし、再認証チャレンジが表示される前に15分が経過した場合、どうなるか？
- 管理者が複数のブラウザタブで管理画面を開いている場合、一つのタブで再認証したら他のタブにも反映されるか？
- 管理者がパスキーを持っていない場合、AAL2保護された管理画面にアクセスできないか？
- AAL2再認証中にセッションタイムアウトが発生した場合、どうなるか？
- 通常ユーザー（非管理者）が誤って管理画面URLにアクセスしようとした場合、AAL2チャレンジは表示されるか、それとも権限エラーが先に表示されるか？
- 管理者が再認証チャレンジ画面でブラウザの「戻る」ボタンを押した場合、どうなるか？
- システム時刻が変更された場合、AAL2タイムスタンプはどう扱われるか？
- APIまたはプログラマティックなアクセス（REST APIなど）を通じて管理機能にアクセスする場合、AAL2保護はどう適用されるか？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、指定された管理画面へのアクセス時に、最後のパスキー認証から15分以上経過しているかを確認しなければならない
- **FR-002**: システムは、15分以上経過している場合、パスキー再認証チャレンジを表示しなければならない
- **FR-003**: システムは、再認証成功後、AAL2認証タイムスタンプを現在時刻に更新しなければならない
- **FR-004**: システムは、再認証失敗またはキャンセル時、管理画面へのアクセスを拒否しなければならない
- **FR-005**: システムは、初期設定として、主要な管理画面（コントロールパネル、ユーザー管理、サイト設定、Add-on管理）をAAL2保護対象としなければならない
- **FR-006**: システムは、サイト管理者がAAL2保護対象の管理画面を設定できるインターフェースを提供しなければならない
- **FR-007**: システムは、URLパターンまたは画面識別子により、保護対象の管理画面を定義できなければならない
- **FR-008**: システムは、AAL2再認証チャレンジ画面に、再認証が必要な理由とアクセスしようとしている画面の情報を表示しなければならない
- **FR-009**: システムは、再認証成功後、元々アクセスしようとしていた管理画面に自動的にリダイレクトしなければならない
- **FR-010**: システムは、管理者がパスキーを登録していない場合、AAL2保護された管理画面へのアクセスを拒否し、パスキー登録を促すメッセージを表示しなければならない
- **FR-011**: システムは、管理画面ヘッダーまたはユーザープロファイルに、現在のAAL2認証状態を表示する機能を提供しなければならない（オプション）
- **FR-012**: システムは、AAL2再認証イベントを監査ログに記録しなければならない
- **FR-013**: システムは、権限チェックを先に実行し、ユーザーが管理画面にアクセスする権限を持つ場合のみAAL2チェックを実行しなければならない
- **FR-014**: システムは、複数のブラウザタブ・ウィンドウ間でAAL2認証状態を共有しなければならない（同一ユーザー）
- **FR-015**: システムは、通常のログイン時にパスキーで認証した場合、AAL2タイムスタンプも初期化しなければならない

### Key Entities

- **Protected Admin Interface**: AAL2保護が適用される管理画面。属性には、URL パターン、画面識別子、表示名、説明が含まれる。
- **AAL2 Configuration**: AAL2保護の設定。保護対象の管理画面リスト、タイムウィンドウ（15分）、有効/無効フラグを含む。
- **AAL2 Authentication Timestamp**: 既存エンティティ（003-aal2-compliance）。ユーザーの最後のパスキー認証時刻を記録。
- **Admin Access Audit Log**: 管理画面へのアクセス試行とAAL2再認証イベントを記録するログエントリ。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 管理者は、AAL2再認証を15秒以内に完了できる（平均）
- **SC-002**: AAL2保護された管理画面へのアクセス試行の100%で、15分ルールが正確に適用される（±5秒の誤差）
- **SC-003**: 管理者の90%以上が、再認証チャレンジの理由を理解できる（ユーザーテストまたはアンケート）
- **SC-004**: AAL2機能により、管理画面へのアクセス時間が平均で5秒以上増加しない（15分以内に認証済みの場合）
- **SC-005**: 再認証成功後、100%のケースで元の管理画面に正しくリダイレクトされる
- **SC-006**: AAL2保護設定の変更は、3クリック以内で完了できる
- **SC-007**: AAL2関連のエラー（タイムスタンプ不整合、リダイレクト失敗など）がアクセス試行の1%未満で発生する

## Assumptions *(if applicable)*

- 003-aal2-complianceで実装されたAAL2認証タイムスタンプ管理機能が利用可能
- 002-passkey-loginで実装されたパスキー登録・認証機能が利用可能
- 管理者は既にパスキーを登録している、または登録を促すメカニズムが存在する
- Ploneの管理画面は識別可能なURLパターンまたはビュー名を持つ
- サーバー時刻は正確で、NTPなどで同期されている
- 15分のタイムウィンドウは初期実装では固定値（将来的には設定可能にする可能性）
- AAL2保護はブラウザベースのアクセスに適用され、REST APIアクセスは別途検討が必要
- 管理者セッションは通常のセッションタイムアウト（例：30分）を持ち、AAL2タイムアウト（15分）とは独立

## Out of Scope *(if applicable)*

- REST APIまたはプログラマティックなアクセスへのAAL2保護適用（将来のフェーズ）
- 15分以外のカスタマイズ可能なタイムウィンドウ（初期実装では固定）
- 管理画面ごとに異なるタイムウィンドウの設定
- パスキー以外の認証方法（SMS、TOTPなど）によるAAL2再認証
- AAL2認証状態のリアルタイム通知（プッシュ通知など）
- 管理者による他のユーザーの強制的なAAL2再認証トリガー
- AAL2監査ログの詳細レポート・分析機能
- ロールベースのAAL2要件（005のタスクで対応済みの可能性あり）
- コンテンツ編集画面へのAAL2保護適用（006は管理画面のみ）
