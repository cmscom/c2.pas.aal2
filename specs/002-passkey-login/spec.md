# 機能仕様書: Ploneログインへのパスキー認証

**フィーチャーブランチ**: `002-passkey-login`
**作成日**: 2025-11-06
**ステータス**: ドラフト
**入力**: ユーザー説明: "通常のPloneのログインにくわえてパスキーに対応する。パスキーはZopeのデータ保存領域（User情報と同様）に入れる。"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー1 - 既存アカウントへのパスキー登録 (優先度: P1)

ログイン中のユーザーが、既存のPloneアカウントにパスキー認証を追加して、今後の訪問時にパスワードレスログインを可能にしたいと考えています。ユーザーはプロフィールのセキュリティ設定に移動し、パスキー登録を開始し、デバイスの生体センサーまたはセキュリティキーを使用して認証します。

**この優先度の理由**: これはパスキーサポートの基盤です。ユーザーはログインに使用する前にパスキーを登録できる必要があります。このストーリーは、セキュリティ意識の高いユーザーがアカウント保護を強化できるようにすることで、即座に価値を提供します。

**独立テスト**: 従来の認証情報でログインし、セキュリティ設定に移動し、パスキー登録フローを完了し、パスキーが保存されユーザーアカウントに関連付けられていることを確認することで、完全にテストできます。

**受け入れシナリオ**:

1. **前提**: プロフィールのセキュリティ設定ページにいるログイン中のユーザー、**操作**: 「パスキーを追加」をクリックしてデバイス認証を完了、**結果**: パスキーが登録され、認証方法のリストに表示される
2. **前提**: 既存のパスキーを持つログイン中のユーザー、**操作**: 別のデバイスから別のパスキーを登録しようとする、**結果**: 両方のパスキーが保存され、デバイス識別子とともに個別にリストされる
3. **前提**: パスキー登録中のログイン中のユーザー、**操作**: ブラウザの認証プロンプトをキャンセル、**結果**: 登録がキャンセルされ、適切なメッセージが表示され、アカウントに影響はない

---

### ユーザーストーリー2 - パスキーでログイン (優先度: P2)

登録されたパスキーを持つリピーターユーザーがPloneログインページにアクセスし、ユーザー名とパスワードを入力する代わりにパスキーを使用して認証することを選択します。システムはデバイスを認識し、生体認証またはセキュリティキーを介してユーザーを認証します。

**この優先度の理由**: これはパスキーのコアバリュープロポジション（より高速で安全なパスワードレス認証）を提供します。P1に依存しますが（ユーザーは最初にパスキーを登録する必要があります）、主要なユーザーメリットを提供します。

**独立テスト**: 登録されたパスキーでログインページにアクセスし、パスキーログインオプションを選択し、デバイス認証を完了し、認証エリアへのログイン成功を確認することでテストできます。

**受け入れシナリオ**:

1. **前提**: ログインページにいる登録されたパスキーを持つユーザー、**操作**: 「パスキーでサインイン」を選択してデバイス認証を完了、**結果**: パスワードを入力せずにアカウントにログインされる
2. **前提**: ログインページにいる複数の登録されたパスキーを持つユーザー、**操作**: 「パスキーでサインイン」を選択、**結果**: 現在のデバイスで複数のパスキーが利用可能な場合、使用するパスキーを選択できる
3. **前提**: パスキーログインを試みるユーザー、**操作**: 認証が失敗またはキャンセルされる、**結果**: ログインページに留まり、再試行または従来のログインを使用するオプションが表示される

---

### ユーザーストーリー3 - 登録されたパスキーの管理 (優先度: P3)

ログイン中のユーザーが、登録されたすべてのパスキーを表示し、どのデバイスに属しているかを特定し、もはや使用または信頼していないデバイスのパスキーを削除したいと考えています。

**この優先度の理由**: 長期的なパスキーの衛生とセキュリティに不可欠ですが、ユーザーはこれが利用可能になる前にパスキーを使用できます。ユーザーが認証方法を管理できるようにします。

**独立テスト**: セキュリティ設定に移動し、デバイス情報とともに登録されたパスキーのリストを表示し、削除するパスキーを選択し、削除を確認し、リストから削除され認証に使用できなくなったことを確認することでテストできます。

**受け入れシナリオ**:

1. **前提**: セキュリティ設定ページにいるログイン中のユーザー、**操作**: パスキーリストを表示、**結果**: 登録日と最終使用タイムスタンプとともにすべての登録されたパスキーが表示される
2. **前提**: パスキーを表示しているログイン中のユーザー、**操作**: 特定のパスキーで「削除」をクリックして確認、**結果**: そのパスキーが削除され、認証に使用できなくなる
3. **前提**: 唯一のパスキーを削除しようとするログイン中のユーザー、**操作**: パスワードが設定されていない、**結果**: システムは削除を防ぎ、少なくとも1つの認証方法（パスワードまたはパスキー）をアクティブに保つ必要があるというメッセージを表示する

---

### ユーザーストーリー4 - 従来のログインへのフォールバック (優先度: P2)

通常パスキーログインを使用するユーザーが、パスキーが登録されていないデバイスからアカウントにアクセスする必要がある、またはパスキーデバイスが利用できない場合があります。従来のユーザー名とパスワードを使用してログインできます。

**この優先度の理由**: ユーザーロックアウトを防ぐために重要です。ユーザーは常にフォールバック認証方法を持つ必要があります。パスキーログイン（P2）が実装されるときに利用可能である必要があるため、これはP2です。

**独立テスト**: 登録されたパスキーのないデバイスからアカウントにアクセスしようとし、従来のログインオプションを選択し、ユーザー名とパスワードを入力し、認証の成功を確認することでテストできます。

**受け入れシナリオ**:

1. **前提**: パスキーを持たないデバイスにいる登録されたパスキーを持つユーザー、**操作**: ログインページで「代わりにパスワードを使用」をクリックして有効な認証情報を入力、**結果**: アカウントに正常にログインされる
2. **前提**: ログインページにいるユーザー、**操作**: パスキーとパスワードの両方のログインオプションが利用可能、**結果**: 両方の認証方法を明確に表示し、切り替えることができる
3. **前提**: パスワードを忘れたが登録されたパスキーを持つユーザー、**操作**: パスキーで正常にログイン、**結果**: プロフィールからパスワードリセット機能にアクセスできる

---

### エッジケース

- ユーザーのパスキーデバイスが紛失または盗難された場合はどうなりますか？（ユーザーストーリー4でカバー - パスワードログインへのフォールバック、さらにユーザーストーリー3 - パスワードでログイン後に侵害されたパスキーを削除）
- ユーザーのブラウザがパスキーをサポートしていない場合、システムはパスキー認証をどのように処理しますか？（システムはサポート不足を検出し、従来のログインオプションのみを表示する必要があります）
- パスキー登録がプロセスの途中で中断された場合はどうなりますか？（部分的なデータは保存されません。ユーザーは登録を再試行できます）
- システムは複数のデバイスからの同時パスキー登録をどのように処理しますか？（各登録は独立してアトミックです）
- パスキーデータの保存が破損またはアクセス不能な場合はどうなりますか？（システムは従来の認証にフォールバックします。管理ツールはデータ整合性の問題にフラグを立てる必要があります）
- ユーザーアカウント削除時にパスキーはどのように処理されますか？（関連するすべてのパスキーはユーザーアカウントとともに削除されます）
- ユーザーが同じ物理セキュリティキーを2回登録しようとした場合はどうなりますか？（システムは重複を検出し、登録を防ぐか、以前のエントリを置き換える必要があります）

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは、認証されたユーザープロフィール/セキュリティ設定からアクセス可能なパスキー登録インターフェースを提供しなければならない
- **FR-002**: システムは、パスキー登録と認証のための業界標準プロトコルをサポートしなければならない
- **FR-003**: システムは、他のユーザー情報と並んでパスキー認証情報データを安全に保存しなければならない
- **FR-004**: システムは、ユーザーがアカウントごとに複数のパスキーを登録できるようにしなければならない
- **FR-005**: システムは、登録されたパスキーを持つユーザーのログインページに「パスキーでサインイン」オプションを表示しなければならない
- **FR-006**: システムは、パスワード入力をバイパスするパスキー認証をサポートしなければならない
- **FR-007**: システムは、フォールバックオプションとして従来のユーザー名/パスワード認証を維持しなければならない
- **FR-008**: システムは、ユーザーがすべての登録されたパスキーを表示するための管理インターフェースを提供しなければならない
- **FR-009**: システムは、ユーザーが個々のパスキーを削除/取り消すことを許可しなければならない
- **FR-010**: システムは、デバイス識別子、登録日、最終使用タイムスタンプを含む各パスキーのメタデータを保存しなければならない
- **FR-011**: システムは、アクセスを許可する前に認証中にパスキー認証情報を検証しなければならない
- **FR-012**: システムは、適切なエラーメッセージを使用してパスキー認証の失敗を適切に処理しなければならない
- **FR-013**: システムは、ブラウザ/デバイスのパスキー機能を検出し、それに応じてUIを調整しなければならない
- **FR-014**: システムは、パスキーが個々のユーザーアカウントにスコープされ、共有できないことを保証しなければならない
- **FR-015**: システムは、セキュリティ監査のためにパスキー登録と認証イベントをログに記録しなければならない
- **FR-016**: システムは、アカウントごとに少なくとも1つの有効な認証方法（パスキーまたはパスワード）を要求することにより、アカウントロックアウトを防止しなければならない。ユーザーは、タイプに関係なく、最後の認証方法を削除できません。
- **FR-017**: システムは、プラットフォーム認証器（デバイスに組み込まれた生体センサー）とローミング認証器（外部セキュリティキー）の両方をサポートしなければならない

### 主要エンティティ

- **パスキー認証情報**: ユーザーアカウント用の登録されたパスキーを表します。主要な属性には、一意の認証情報識別子、安全な認証情報データ、デバイス識別子/名前、登録タイムスタンプ、最終使用タイムスタンプ、ユーザー関連付け、および認証器タイプ（組み込みデバイスセンサー対外部セキュリティキー）が含まれます。
- **ユーザーアカウント**: 既存のPloneユーザーエンティティ。関係: 1つのユーザーアカウントは複数のパスキー認証情報を持つことができます。各パスキー認証情報は正確に1つのユーザーアカウントに属します。
- **認証イベント**: パスキー登録と認証試行を記録するログエントリ。属性には、イベントタイプ（登録/認証/削除）、ユーザー識別子、タイムスタンプ、成功/失敗ステータス、デバイス情報、およびIPアドレスが含まれます。

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 登録されたパスキーを持つユーザーは、10秒以内にログインを完了できる（従来のパスワード入力と比較して）
- **SC-002**: パスキー登録プロセスは、互換性のあるデバイスを持つユーザーによって60秒以内に完了できる
- **SC-003**: システムは、パスキーと従来の認証方法の両方で99.9%の可用性を維持する
- **SC-004**: パスキー実装によるアカウントロックアウトはゼロ発生する（フォールバックメカニズムが正しく機能する）
- **SC-005**: パスキー認証試行の100%がセキュリティ監査目的でログに記録される
- **SC-006**: ユーザーは管理者の支援を必要とせずにパスキーを管理（表示/追加/削除）できる
- **SC-007**: 有効な認証情報が使用される場合、パスキー認証の成功率は95%を超える（ユーザーのキャンセルとデバイスの問題を考慮）

## 前提条件

1. **ブラウザサポート**: 対象ユーザーが使用する最新のブラウザは、パスキー認証標準をサポートしています
2. **デバイスの可用性**: パスキーを登録するユーザーは、互換性のあるデバイス（生体センサーまたはセキュリティキー）にアクセスできます
3. **ストレージ容量**: システムのユーザーデータストレージは、重大なサイズ制約なしにパスキー認証情報データを収容できます
4. **セッション管理**: 既存の認証セッション管理は、パスキー認証フローをサポートするように拡張できます
5. **ユーザー教育**: ユーザーはパスキー/生体認証の基本的な理解を持っているか、ドキュメント/ヘルプテキストが別途提供されます
6. **安全な接続**: システムは、安全な暗号化接続を介してアクセスされます（パスキー技術に必要）
7. **シングルサイトスコープ**: パスキーは、この特定のサイトインスタンスにスコープされ、複数のサイト間で共有されません
8. **ブラウザプロンプト**: ユーザーは、ブラウザネイティブの認証プロンプトを理解し、応答できます（アプリケーションによってカスタマイズできません）

## 依存関係

- プラガブル認証フレームワークを備えたPlone 5.2以降
- アプリケーションに対して有効にされた安全な暗号化接続（HTTPS）
- クライアントデバイスでのパスキー認証のブラウザサポート
- 認証情報データのデータベースストレージ容量（通常は小さい、パスキーあたり<1KB）

## スコープ外

- クロスデバイスパスキー同期（ユーザーのデバイスエコシステム、例：Apple Keychain、Google Password Managerによって処理されます）
- パスキー登録を強制するか、サイト全体でパスワード認証を無効にする管理ツール
- 従来のパスワードフォールバックを超えたパスキー回復メカニズム
- 外部IDプロバイダーまたはSSOシステムとの統合
- モバイルアプリ固有のパスキー実装（スコープはWebブラウザアクセスのみ）
- パスワードフォールバックを超えたバックアップコードまたは代替緊急アクセス方法
- パスキー共有または委任機能
- 標準ブラウザパスキープロンプトを超えたカスタム認証UI
