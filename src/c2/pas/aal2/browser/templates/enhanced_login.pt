<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="plone">

<head>
  <metal:block fill-slot="javascript_head_slot">
    <script type="text/javascript" tal:content="structure string:
      // Check WebAuthn support
      var webauthnSupported = !!window.PublicKeyCredential;

      // Show/hide passkey option based on browser support
      document.addEventListener('DOMContentLoaded', function() {
        if (!webauthnSupported) {
          var passkeySection = document.getElementById('passkey-login-section');
          if (passkeySection) {
            passkeySection.style.display = 'none';
          }
          var noSupportWarning = document.getElementById('webauthn-not-supported');
          if (noSupportWarning) {
            noSupportWarning.style.display = 'block';
          }
        }
      });

      // Toggle between password and passkey forms
      function showPasswordForm() {
        document.getElementById('password-login-section').style.display = 'block';
        document.getElementById('passkey-login-section').style.display = 'none';
      }

      function showPasskeyForm() {
        document.getElementById('password-login-section').style.display = 'none';
        document.getElementById('passkey-login-section').style.display = 'block';
      }
    ">
    </script>
  </metal:block>
</head>

<body>
  <metal:content-core fill-slot="content-core">
    <metal:block define-macro="content-core">

      <h1 class="documentFirstHeading" i18n:translate="">Sign In</h1>

      <div class="documentDescription" i18n:translate="">
        Choose your preferred sign-in method below.
      </div>

      <!-- WebAuthn not supported warning -->
      <div id="webauthn-not-supported" class="portalMessage warning" style="display: none;">
        <strong i18n:translate="">Your browser doesn't support passkeys</strong>
        <p i18n:translate="">
          Please use password login below or upgrade to a modern browser (Chrome, Firefox, Safari, or Edge).
        </p>
      </div>

      <!-- Login method selector -->
      <div class="login-method-selector" style="margin-bottom: 1.5em; text-align: center;">
        <button type="button"
                onclick="showPasskeyForm()"
                id="show-passkey-btn"
                class="btn btn-primary"
                i18n:translate="">
          Sign in with Passkey
        </button>
        <span style="margin: 0 1em;" i18n:translate="">or</span>
        <button type="button"
                onclick="showPasswordForm()"
                id="show-password-btn"
                class="btn btn-secondary"
                i18n:translate="">
          Use Password Instead
        </button>
      </div>

      <!-- Passkey login section -->
      <div id="passkey-login-section" style="display: block;">
        <h2 i18n:translate="">Sign in with Passkey</h2>

        <div class="documentDescription" i18n:translate="">
          Use your passkey (biometric sensor or security key) to sign in securely without a password.
        </div>

        <div id="passkey-login-info" class="portalMessage info" style="display: none;">
          <strong i18n:translate="">Touch your security key or use your device's biometric sensor</strong>
        </div>

        <div id="passkey-error" class="portalMessage error" style="display: none;"></div>
        <div id="passkey-success" class="portalMessage info" style="display: none;"></div>

        <form id="login-passkey-form" method="post">
          <div class="field">
            <label for="passkey-username" i18n:translate="">Username or Email (Optional)</label>
            <div class="formHelp" i18n:translate="">
              Enter your username to filter available passkeys, or leave blank to use any registered passkey
            </div>
            <input type="text"
                   id="passkey-username"
                   name="username"
                   class="form-control"
                   placeholder="username"
                   i18n:attributes="placeholder" />
          </div>

          <div class="formControls">
            <button type="button"
                    id="passkey-login-button"
                    class="btn btn-primary"
                    i18n:translate="">
              Sign in with Passkey
            </button>
          </div>
        </form>
      </div>

      <!-- Password login section -->
      <div id="password-login-section" style="display: none;">
        <h2 i18n:translate="">Sign in with Password</h2>

        <tal:block tal:replace="structure view/standard_login_form" />

        <div class="formHelp" style="margin-top: 1em;">
          <p i18n:translate="">
            <a tal:attributes="href string:${context/portal_url}/@@mail_password_form">
              Forgot your password?
            </a>
          </p>
        </div>
      </div>

    </metal:block>
  </metal:content-core>

  <metal:javascript fill-slot="javascript_head_slot">
    <!-- Load WebAuthn JavaScript modules -->
    <script tal:attributes="src string:${context/portal_url}/++resource++c2.pas.aal2/js/webauthn-utils.js"></script>
    <script tal:attributes="src string:${context/portal_url}/++resource++c2.pas.aal2/js/webauthn-login.js"></script>

    <!-- Initialize enhanced login (password + passkey) -->
    <script type="text/javascript">
      document.addEventListener('DOMContentLoaded', function() {
        initEnhancedLogin({
          usernameInputId: 'passkey-username',
          loginButtonId: 'passkey-login-button',
          autoFillUsername: false
        });
      });
    </script>
  </metal:javascript>

</body>
</html>
