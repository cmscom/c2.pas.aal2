<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="c2.pas.aal2">

<body>
  <metal:content-core fill-slot="content-core">
    <metal:block define-macro="content-core">

      <h1 class="documentFirstHeading" i18n:translate="">Manage Your Passkeys</h1>

      <div class="documentDescription" i18n:translate="">
        View and manage your registered passkeys. You can rename or remove passkeys from this page.
      </div>

      <div id="passkey-error" class="portalMessage error" style="display: none;"></div>
      <div id="passkey-success" class="portalMessage info" style="display: none;"></div>

      <div class="formControls" style="margin-bottom: 1em;">
        <a tal:attributes="href string:${context/portal_url}/@@passkey-register-form"
           class="btn btn-primary"
           i18n:translate="">
          Add New Passkey
        </a>
      </div>

      <div id="passkey-loading" style="display: none;">
        <p i18n:translate="">Loading passkeys...</p>
      </div>

      <div id="passkey-list-container">
        <!-- Passkeys will be loaded here via JavaScript -->
      </div>

      <div id="no-passkeys" style="display: none;" class="portalMessage info">
        <strong i18n:translate="">No passkeys registered</strong>
        <p i18n:translate="">
          You haven't registered any passkeys yet.
          <a href="#" onclick="window.location.href='@@passkey-register-form'; return false;">Add your first passkey</a>
          to enable passwordless login.
        </p>
      </div>

    </metal:block>
  </metal:content-core>

  <metal:javascript fill-slot="javascript_head_slot">
    <script type="text/javascript" tal:content="structure string:
      // Load passkeys when page loads
      document.addEventListener('DOMContentLoaded', function() {
        loadPasskeys();
      });

      async function loadPasskeys() {
        const loadingDiv = document.getElementById('passkey-loading');
        const containerDiv = document.getElementById('passkey-list-container');
        const noPasskeysDiv = document.getElementById('no-passkeys');
        const errorDiv = document.getElementById('passkey-error');

        loadingDiv.style.display = 'block';
        containerDiv.innerHTML = '';
        noPasskeysDiv.style.display = 'none';
        errorDiv.style.display = 'none';

        try {
          const response = await fetch('@@passkey-list', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            }
          });

          if (!response.ok) {
            throw new Error('Failed to load passkeys');
          }

          const data = await response.json();
          const passkeys = data.passkeys || [];

          loadingDiv.style.display = 'none';

          if (passkeys.length === 0) {
            noPasskeysDiv.style.display = 'block';
            return;
          }

          // Create table
          const table = document.createElement('table');
          table.className = 'listing';

          // Table header
          const thead = document.createElement('thead');
          thead.innerHTML = `
            <tr>
              <th>Device Name</th>
              <th>Type</th>
              <th>Registered</th>
              <th>Last Used</th>
              <th>Actions</th>
            </tr>
          `;
          table.appendChild(thead);

          // Table body
          const tbody = document.createElement('tbody');
          passkeys.forEach(function(passkey) {
            const row = document.createElement('tr');

            const createdDate = passkey.created ? new Date(passkey.created).toLocaleString() : 'Unknown';
            const lastUsedDate = passkey.last_used ? new Date(passkey.last_used).toLocaleString() : 'Never';
            const deviceType = passkey.device_type === 'platform' ? 'This Device' : 'Security Key';

            row.innerHTML = `
              <td>
                <span class=\\"device-name\\" data-credential-id=\\"$${passkey.credential_id}\\">${passkey.device_name || 'Unnamed Device'}</span>
                <button onclick=\\"editDeviceName('$${passkey.credential_id}')\\" class=\\"btn btn-sm btn-secondary\\">Edit</button>
              </td>
              <td>${deviceType}</td>
              <td>${createdDate}</td>
              <td>${lastUsedDate}</td>
              <td>
                <button onclick=\\"deletePasskey('$${passkey.credential_id}')\\" class=\\"btn btn-sm btn-danger\\">Delete</button>
              </td>
            `;
            tbody.appendChild(row);
          });

          table.appendChild(tbody);
          containerDiv.appendChild(table);

        } catch (error) {
          loadingDiv.style.display = 'none';
          console.error('Error loading passkeys:', error);
          errorDiv.innerHTML = '<strong>Error:</strong> Failed to load passkeys. Please refresh the page.';
          errorDiv.style.display = 'block';
        }
      }

      async function deletePasskey(credentialId) {
        if (!confirm('Are you sure you want to delete this passkey? This action cannot be undone.')) {
          return;
        }

        const errorDiv = document.getElementById('passkey-error');
        const successDiv = document.getElementById('passkey-success');

        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';

        try {
          const response = await fetch('@@passkey-delete', {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              credential_id: credentialId
            })
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.message || 'Failed to delete passkey');
          }

          // Success
          successDiv.innerHTML = '<strong>Success!</strong> ' + result.message;
          successDiv.style.display = 'block';

          // Reload the list
          setTimeout(function() {
            loadPasskeys();
            successDiv.style.display = 'none';
          }, 2000);

        } catch (error) {
          console.error('Error deleting passkey:', error);
          errorDiv.innerHTML = '<strong>Error:</strong> ' + error.message;
          errorDiv.style.display = 'block';
        }
      }

      function editDeviceName(credentialId) {
        const nameSpan = document.querySelector('.device-name[data-credential-id=\\\"' + credentialId + '\\\"]');
        const currentName = nameSpan.textContent;

        const newName = prompt('Enter a new name for this passkey:', currentName);

        if (newName === null || newName === currentName) {
          return; // User cancelled or no change
        }

        updateDeviceName(credentialId, newName);
      }

      async function updateDeviceName(credentialId, deviceName) {
        const errorDiv = document.getElementById('passkey-error');
        const successDiv = document.getElementById('passkey-success');

        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';

        try {
          const response = await fetch('@@passkey-update', {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              credential_id: credentialId,
              device_name: deviceName
            })
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.message || 'Failed to update passkey');
          }

          // Success
          successDiv.innerHTML = '<strong>Success!</strong> ' + result.message;
          successDiv.style.display = 'block';

          // Reload the list
          setTimeout(function() {
            loadPasskeys();
            successDiv.style.display = 'none';
          }, 2000);

        } catch (error) {
          console.error('Error updating passkey:', error);
          errorDiv.innerHTML = '<strong>Error:</strong> ' + error.message;
          errorDiv.style.display = 'block';
        }
      }
    ">
    </script>
  </metal:javascript>

</body>
</html>
